name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test-backend:
    name: Test Backend (Rust)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
      
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run Rust tests
        run: cargo test --verbose
      
      - name: Test summary
        run: |
          echo "âœ… All 201 Rust tests passed!"

  test-frontend:
    name: Test Frontend (JavaScript)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: res/tests/node_modules
          key: ${{ runner.os }}-npm-test-${{ hashFiles('res/tests/package-lock.json') }}

      - name: Install test dependencies
        working-directory: res/tests
        run: npm install

      - name: Run JavaScript tests
        working-directory: res/tests
        run: npm test

      - name: Test summary
        run: |
          echo "âœ… All 262+ JavaScript tests passed!"

  test-release-build:
    name: Test Release Build (Import Integrity)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Run release build check
        run: ./scripts/check-release.sh

  create-release:
    name: Create Release
    needs: [test-backend, test-frontend, test-release-build]
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes generation

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: get version
        run: echo "PACKAGE_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: generate release notes
        id: release-notes
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"%s" --no-merges)
          else
            echo "Generating notes from $PREV_TAG to HEAD"
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges)
          fi

          # Initialize sections
          FEAT=""
          FIX=""
          REFACTOR=""
          DOCS=""
          CI=""
          TEST=""
          CHORE=""
          OTHER=""

          # Process each commit
          while IFS= read -r line; do
            # Skip empty lines, [skip ci], and Revert commits
            [ -z "$line" ] && continue
            echo "$line" | grep -qi "\[skip ci\]" && continue
            echo "$line" | grep -qi "^Revert" && continue

            # Extract type and message
            if echo "$line" | grep -qE "^feat(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^feat(\(.*\))?:\s*//')
              FEAT="${FEAT}- ${MSG}\n"
            elif echo "$line" | grep -qE "^fix(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^fix(\(.*\))?:\s*//')
              FIX="${FIX}- ${MSG}\n"
            elif echo "$line" | grep -qE "^refactor(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^refactor(\(.*\))?:\s*//')
              REFACTOR="${REFACTOR}- ${MSG}\n"
            elif echo "$line" | grep -qE "^docs(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^docs(\(.*\))?:\s*//')
              DOCS="${DOCS}- ${MSG}\n"
            elif echo "$line" | grep -qE "^ci(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^ci(\(.*\))?:\s*//')
              CI="${CI}- ${MSG}\n"
            elif echo "$line" | grep -qE "^test(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^test(\(.*\))?:\s*//')
              TEST="${TEST}- ${MSG}\n"
            elif echo "$line" | grep -qE "^chore(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^chore(\(.*\))?:\s*//')
              CHORE="${CHORE}- ${MSG}\n"
            else
              OTHER="${OTHER}- ${line}\n"
            fi
          done <<< "$COMMITS"

          # Build release notes
          NOTES="## What's Changed\n\n"

          [ -n "$FEAT" ] && NOTES="${NOTES}### âœ¨ Features\n${FEAT}\n"
          [ -n "$FIX" ] && NOTES="${NOTES}### ðŸ› Bug Fixes\n${FIX}\n"
          [ -n "$REFACTOR" ] && NOTES="${NOTES}### â™»ï¸ Refactoring\n${REFACTOR}\n"
          [ -n "$DOCS" ] && NOTES="${NOTES}### ðŸ“š Documentation\n${DOCS}\n"
          [ -n "$CI" ] && NOTES="${NOTES}### ðŸ”§ CI/CD\n${CI}\n"
          [ -n "$TEST" ] && NOTES="${NOTES}### ðŸ§ª Tests\n${TEST}\n"
          [ -n "$CHORE" ] && NOTES="${NOTES}### ðŸ”¨ Chores\n${CHORE}\n"
          [ -n "$OTHER" ] && NOTES="${NOTES}### ðŸ“ Other\n${OTHER}\n"

          # Add compare link
          if [ -n "$PREV_TAG" ]; then
            NOTES="${NOTES}**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${PACKAGE_VERSION}"
          fi

          # Save to file for multi-line support
          echo -e "$NOTES" > release_notes.md
          cat release_notes.md

      - name: create release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release_notes.md', 'utf8');
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${process.env.PACKAGE_VERSION}`,
              name: `KakeiBon v${process.env.PACKAGE_VERSION}`,
              body: releaseNotes,
              draft: true,
              prerelease: false
            })
            return data.id

  build-tauri:
    name: Build Tauri App
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest' # for Arm based macs (M1 and above).
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest' # for Intel based macs.
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04' # for Tauri v2 you could replace this with ubuntu-22.04.
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # Those targets are only used on macos runners so it's in an `if` to slightly speed up windows and linux builds.
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04' # This must match the platform value defined above.
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
        # This app uses Tauri v2 (webkitgtk 4.1). 4.0 is kept for compatibility.

      - name: install dependencies (windows only)
        if: matrix.platform == 'windows-latest'
        shell: powershell
        run: |
          # Install MSYS2
          choco install msys2 -y --no-progress
          # Wait for installation to complete
          Start-Sleep -Seconds 10
          # Find MSYS2 installation path
          $msys2Path = if (Test-Path "C:\tools\msys2") { "C:\tools\msys2" } else { "C:\msys64" }
          Write-Host "MSYS2 path: $msys2Path"
          # Check if bash exists
          if (Test-Path "$msys2Path\usr\bin\bash.exe") {
            Write-Host "bash.exe found at $msys2Path\usr\bin\bash.exe"
            # Update MSYS2 package database
            & "$msys2Path\usr\bin\bash.exe" -lc "pacman -Syu --noconfirm"
            # Install GLib
            & "$msys2Path\usr\bin\bash.exe" -lc "pacman -S --noconfirm mingw-w64-x86_64-glib2 mingw-w64-x86_64-pkg-config"
            # Add to PATH
            echo "$msys2Path\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            echo "PKG_CONFIG_PATH=$msys2Path\mingw64\lib\pkgconfig" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Error "bash.exe not found in $msys2Path"
            exit 1
          }

      - name: install frontend dependencies
        run: npm install

      - name: Setup cross-compilation for macOS x86_64
        if: matrix.platform == 'macos-latest' && contains(matrix.args, 'x86_64-apple-darwin')
        run: |
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:/usr/lib/pkgconfig" >> $GITHUB_ENV

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Enable cross-compilation support for pkg-config
          PKG_CONFIG_ALLOW_CROSS: ${{ matrix.platform == 'macos-latest' && contains(matrix.args, 'x86_64-apple-darwin') && '1' || '' }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

  publish-release:
    name: Publish Release
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    needs: [create-release, build-tauri]

    steps:
      - name: publish release
        id: publish-release
        uses: actions/github-script@v7
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.release_id,
              draft: false,
              prerelease: false
            })
